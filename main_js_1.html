<script>
  let formComponent;
  const SELECT_MANIP = "select_manip";
  const SELECT_USER = "select_user";
  const INPUT_LIST = "input_list";

  const manipSelector = document.getElementById(SELECT_MANIP);
  const userSelector = document.getElementById(SELECT_USER)
  /**
   * @class
   * Form component
   */
  class FormComponent {
    /**
     * @param {object[]} userArray
     * @param {object[]} manipArray
     * @constructor
     */
    constructor(userArray, manipArray) {
      /**
       * @type {object[]}
       * Array of selectable users
       * parameters :
       * @type {string} lastName
       * @type {string} firstName
       * @type {number} number
       */
      this.userArray = userArray.map((user)=>({...user,
        id : user.nickName + "_" +user.number
      }))
      /**
       * @type {object[]}
       * Array of selectable manip
       * parameters :
       * @type {string} date
       * @type {string} name
       */
      this.manipArray = manipArray.map((manip)=>({...manip,hasAnInput : false}));

      /**
       * @type {object[]}
       * Array of manip which got an input
       * parameters :
       *
       */
      this.inputArray = [];
      /**
       * @type {number}
       * Index of the chosen user
       */
      this.chosenUserIndex = this.userArray[0];
      /**
       * @type {boolean}
       * If the form is submited or not
       */
      this.isSubmited = false;
      /**
       * @type {boolean}
       * If the form has been validated by the back-end
       */
      this.isValidated = false;

      this.buildManipSelector()
      .then(onSuccess)
      .catch(onError);

      this.buildUserSelector()
      .then(onSuccess)
      .catch(onError);
    }

    /**
     */
    buildManipSelector() {
      return new Promise((resolve, reject) => {
        try {
          for (let i = 0; i < manipSelector.options.length; i++) {
            manipSelector.options[i] = null;
          }
          for (let manip of this.manipArray) {
            if (!manip.hasAnInput) {
              console.log("for loop : " + manip.name);
              manipSelector.appendChild(getNewManipOption(manip.name));
            }
          }
          resolve("manip selector building successfull");
        } catch (err) {
          reject(err);
        }
      });
    }

    /**
     */
    buildUserSelector() {
      return new Promise((resolve, reject) => {
        try {
          let newOpt;
          for (let user of this.userArray) {
            userSelector.appendChild(getNewUserOption(user));
          }
          resolve("user selector building successfull");
        } catch(e){
          reject(e);
        }
      })
    }

    addManipInput() {
      return new Promise((resolve, reject) => {
        // disabled manipSelector

        const manipValue = manipSelector.value;
        const manipIndex = this.manipArray.findIndex((manip)=> manip.name === manipValue);
        const manip = this.manipArray[manipIndex];
        if(manip && manip.hasAnInput === true){
            reject("Manip already has an input");
        }

        createNewInput(manip.name,manipIndex)
        .then((newInputLi)=>{
          const inputList = document.getElementByID(INPUT_LIST);
          inputList.appendChild(newInputLi);
          manip.hasAnInput = true;
          resolve();
        })
        .catch(onError)
      })
      }


      removeManipFromSelector(){

      }
  }


  /**
   * @param {object} err
   */
  const onError = (error) => {
    console.log("Got an error :")
    console.log(error.message);
    console.error(error)
  }

  /**
   * @param {object} success
   */
  const onSuccess = (success) => {
    console.log("Success : " + JSON.stringify(success))
  }

  const getNewUserOption = (user,selected)=> new Option(upperFirstLetter(user.firstName)
      + " " + upperFirstLetter(user.lastName),
      user.id, selected? true : false, false)

  const getNewManipOption = (manipName,selected)=> new Option(manipName, manipName, selected? true : false, false)

  const getNewInput = (manipName) => {
    return new Promise((resolve,reject)=>{
      const newInputLi = document.createElement("li");
      newInputLi.manipName = manipName;
      newInputLi.manipIndex = manipIndex
      // title
      const title = document.createElement("h3");
      title.innerHTML = manipName;
      // input
      const input = document.createElement("input");
      newInputLi.appendChild(document.createElement("input"));
      // button
      const button = document.createElement("button");
      button.innerHTML = "Delete";
      //button.onClick = () => this.removeManip("manipName");

      newInputLi.appendChild(title);
      newInputLi.appendChild(input);
      newInputLi.appendChild(button);
      resolve(newInputLi)
    })
  }

  const inputTemplate = `<li>
  <h3>
  <input>
  <button onClick="test()">
  </button>
  </h3>
  </li>`

  /**
   * @param {string} a string
   */
  const upperFirstLetter = (str) => str[0].toUpperCase() + str.slice(1).toLowerCase();
</script>
